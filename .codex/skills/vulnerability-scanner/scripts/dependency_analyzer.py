#!/usr/bin/env python3
"""
Dependency Analyzer
Checks dependency lockfile hygiene and known vulnerabilities.

Usage:
    python dependency_analyzer.py <project_path>
"""

import json
import shutil
import subprocess
import sys
from pathlib import Path
from typing import Dict


def parse_npm_audit(report: Dict) -> Dict[str, int]:
    counts = {"critical": 0, "high": 0, "moderate": 0, "low": 0}

    metadata = report.get("metadata", {})
    vulnerabilities = metadata.get("vulnerabilities")
    if isinstance(vulnerabilities, dict):
        for key in counts:
            value = vulnerabilities.get(key, 0)
            counts[key] = int(value) if isinstance(value, int) else 0
        return counts

    advisories = report.get("advisories", {})
    if isinstance(advisories, dict):
        for advisory in advisories.values():
            severity = str(advisory.get("severity", "")).lower()
            if severity in counts:
                counts[severity] += 1
    return counts


def run_npm_audit(project: Path) -> Dict:
    npm_bin = shutil.which("npm.cmd") or shutil.which("npm")
    if npm_bin is None:
        return {"available": False, "reason": "npm command not found", "counts": None}

    try:
        result = subprocess.run(
            [npm_bin, "audit", "--json"],
            cwd=str(project),
            capture_output=True,
            text=True,
            timeout=180,
        )
    except FileNotFoundError:
        return {"available": False, "reason": "npm command not found", "counts": None}
    except subprocess.TimeoutExpired:
        return {"available": True, "reason": "npm audit timed out", "counts": None}

    raw = result.stdout.strip() or result.stderr.strip()
    if not raw:
        return {"available": True, "reason": "npm audit returned no output", "counts": None}

    try:
        parsed = json.loads(raw)
    except json.JSONDecodeError:
        return {"available": True, "reason": "npm audit output was not valid JSON", "counts": None}

    counts = parse_npm_audit(parsed)
    return {"available": True, "reason": None, "counts": counts}


def main() -> int:
    project = Path(sys.argv[1] if len(sys.argv) > 1 else ".").resolve()
    if not project.exists():
        print(json.dumps({"error": f"Project path does not exist: {project}"}))
        return 1

    package_json = project / "package.json"
    if not package_json.exists():
        print(
            json.dumps(
                {
                    "script": "dependency_analyzer",
                    "project": str(project),
                    "detected": "non-node-project",
                    "passed": True,
                    "message": "No package.json found; dependency audit skipped",
                },
                indent=2,
            )
        )
        return 0

    lockfiles = ["package-lock.json", "pnpm-lock.yaml", "yarn.lock", "npm-shrinkwrap.json"]
    found_lockfiles = [name for name in lockfiles if (project / name).exists()]
    lockfile_ok = len(found_lockfiles) > 0

    audit = run_npm_audit(project)
    counts = audit.get("counts") or {"critical": 0, "high": 0, "moderate": 0, "low": 0}

    has_blocking_vulns = counts["critical"] > 0 or counts["high"] > 0
    passed = lockfile_ok and not has_blocking_vulns

    output = {
        "script": "dependency_analyzer",
        "project": str(project),
        "lockfile_ok": lockfile_ok,
        "lockfiles_found": found_lockfiles,
        "audit": audit,
        "vulnerability_counts": counts,
        "passed": passed,
    }

    if not lockfile_ok:
        output["failure_reason"] = "No lockfile found"
    elif has_blocking_vulns:
        output["failure_reason"] = "High or critical vulnerabilities found"

    print(json.dumps(output, indent=2))
    return 0 if passed else 1


if __name__ == "__main__":
    sys.exit(main())
